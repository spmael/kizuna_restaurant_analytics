{% extends 'restaurant_data/base.html' %}
{% load static i18n crispy_forms_tags %}

{% block page_title %}
    {% if object %}{% trans "Edit Purchase" %}{% else %}{% trans "Add Purchase" %}{% endif %}
{% endblock %}

{% block restaurant_data_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'restaurant_data:purchase_list' %}">
                        <i class="fas fa-shopping-cart me-1"></i>{% trans "Purchases" %}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% if object %}{% trans "Edit Purchase" %}{% else %}{% trans "Add Purchase" %}{% endif %}
                </li>
            </ol>
        </nav>

        <!-- Form Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    {% if object %}
                        <i class="fas fa-edit me-2"></i>{% trans "Edit Purchase" %}
                    {% else %}
                        <i class="fas fa-plus me-2"></i>{% trans "Add New Purchase" %}
                    {% endif %}
                </h1>
                <p class="text-muted mb-0">
                    {% if object %}
                        {% trans "Update the purchase information below." %}
                    {% else %}
                        {% trans "Fill in the purchase information below to record a new purchase." %}
                    {% endif %}
                </p>
            </div>
            <a href="{% url 'restaurant_data:purchase_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>{% trans "Back to List" %}
            </a>
        </div>

        <!-- Purchase Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    {% if object %}{% trans "Purchase Information" %}{% else %}{% trans "New Purchase Information" %}{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <ul class="mb-0">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% crispy form %}
                </form>
            </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>{% trans "Help & Tips" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>{% trans "Purchase Information" %}</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Select the product being purchased" %}</li>
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Enter the purchase date" %}</li>
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Specify the quantity purchased" %}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Cost Information" %}</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Enter the total cost for this purchase" %}</li>
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Cost will be used to update product cost per unit" %}</li>
                            <li><i class="fas fa-check text-success me-2"></i>{% trans "Stock will be automatically updated" %}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-calculate cost per unit when quantity or total cost changes
    $('#id_quantity_purchased, #id_total_cost').on('input', function() {
        var quantity = parseFloat($('#id_quantity_purchased').val()) || 0;
        var totalCost = parseFloat($('#id_total_cost').val()) || 0;
        
        if (quantity > 0 && totalCost > 0) {
            var costPerUnit = totalCost / quantity;
            // Update cost per unit display if it exists
            if ($('#cost-per-unit-display').length) {
                $('#cost-per-unit-display').text(costPerUnit.toFixed(2));
            }
        }
    });
    
    // Form validation
    $('form').on('submit', function(e) {
        var quantity = parseFloat($('#id_quantity_purchased').val()) || 0;
        var totalCost = parseFloat($('#id_total_cost').val()) || 0;
        
        if (quantity <= 0) {
            alert('{% trans "Quantity must be greater than 0." %}');
            e.preventDefault();
            return false;
        }
        
        if (totalCost <= 0) {
            alert('{% trans "Total cost must be greater than 0." %}');
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %} 